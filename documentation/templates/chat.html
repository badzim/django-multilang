{% extends "base.html" %}
{% load i18n %}
{% block title %}Chatbot{% endblock %}
{% block content %}
<h1>{% translate "templates.base.chatbot_title" %}</h1>
<div id="chat-container" class="card">
    <div id="chat-log" class="card-body"></div>
    <form id="chat-form" class="card-footer">
        <input type="text" id="chat-input" class="form-control" 
               placeholder="{% translate 'templates.base.chatbot_input_placeholder' %}" required>
        <button type="submit" id="send-button" class="btn btn-primary">
            {% translate 'templates.base.chatbot_send_button' %}
        </button>
        <button type="button" id="clear-button" class="btn btn-danger">
            {% translate 'Clear' %}
        </button>
    </form>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/12.2.0/markdown-it.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatLog = document.getElementById('chat-log');
        const sendButton = document.getElementById('send-button');
        const clearButton = document.getElementById('clear-button');

        // Fonction pour sauvegarder les messages dans le localStorage
        function saveMessages() {
            const messages = chatLog.innerHTML;
            localStorage.setItem('chatbotMessages', messages);
        }

        // Fonction pour restaurer les messages du localStorage
        function loadMessages() {
            const messages = localStorage.getItem('chatbotMessages');
            if (messages) {
                chatLog.innerHTML = messages;
                chatLog.scrollTop = chatLog.scrollHeight;
            }
        }

        // Fonction pour effacer les messages
        function clearMessages() {
            chatLog.innerHTML = '';
            localStorage.removeItem('chatbotMessages');
        }

        // Restaurer les messages au chargement de la page
        loadMessages();

        chatForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (message) {
                chatInput.value = '';

                // Désactiver le bouton de soumission
                sendButton.disabled = true;

                // Afficher le message de l'utilisateur
                const userMessage = document.createElement('div');
                userMessage.textContent = message;
                userMessage.className = 'user-message alert alert-primary';
                chatLog.appendChild(userMessage);
                saveMessages(); // Sauvegarder les messages

                // Afficher le message de chargement du chatbot
                const botLoadingMessage = document.createElement('div');
                botLoadingMessage.textContent = '...';
                botLoadingMessage.className = 'bot-message alert alert-secondary';
                chatLog.appendChild(botLoadingMessage);
                saveMessages(); // Sauvegarder les messages

                // Envoyer la requête au serveur
                const response = await fetch('{% url "chatbot" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ question: message })
                });

                const data = await response.json();
                // Supprimer le "..." et ajouter la réponse réelle
                chatLog.removeChild(botLoadingMessage);
                const md = window.markdownit();
                const botMessage = document.createElement('div');
                botMessage.innerHTML = md.render(data.answer);
                botMessage.className = 'bot-message alert alert-secondary';
                chatLog.appendChild(botMessage);
                chatLog.scrollTop = chatLog.scrollHeight;
                saveMessages(); // Sauvegarder les messages

                // Réactiver le bouton de soumission
                sendButton.disabled = false;
            }
        });

        clearButton.addEventListener('click', function () {
            clearMessages();
        });
    });
</script>
<style>
#chat-container {
    max-width: 100%;
    margin: 0 auto;
    margin-top: 20px;
    border: 1px solid #dee2e6;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}
#chat-log {
    height: 70vh;
    overflow-y: auto;
    padding: 10px;
    border-bottom: 1px solid #dee2e6;
    background-color: #fff;
    border-radius: 10px 10px 0 0;
}
.user-message, .bot-message {
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 5px;
}
.user-message {
    background-color: #dcf8c6;
    text-align: right;
}
.bot-message {
    background-color: #eee;
    text-align: left;
}
#chat-form {
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 0 0 10px 10px;
    display: flex;
    gap: 10px;  /* Ajout de l'espace entre le champ de saisie et le bouton */
}

#clear-button {
    margin-left: auto;  /* Align the button to the right */
}
</style>
{% endblock %}
